package de.fabiangroeger.adventofcode

import kotlin.collections.buildList
import kotlin.collections.first
import kotlin.test.Test

class Day7Laboratories {
    @Test
    fun executePartOne() {
        val beams = beam.lines()
            .map { BeamRow.fromString(it) }

        val transformedBeam = beams.transform(
            BeamRow(
                buildList {
                    repeat(beams.first().beam.size) {
                        add(Field.Empty)
                    }
                }
            ),
        )

        val output = transformedBeam.first().calculateTotalSplits()
        println(output)
    }

    @Test
    fun executePartTwo() {
        val beams = beam.lines()
            .map { BeamRow.fromString(it) }

        val transformedBeam = beams.drop(1).transform(
            beams.first(),
            )

        require(transformedBeam.size == 1)

        transformedBeam.first().print()

        val output = transformedBeam.first().last().beam.sumOf {
            it.value
        }

        println(output)
    }

    fun List<BeamRow>.transform(previousRow: BeamRow): List<List<BeamRow>> {
        val source = this

        if (source.isEmpty()) {
            return emptyList()
        }

        val transformedRow = source.first().transform(previousRow)

        return buildSet {
            val next = source.drop(1)

            if (next.isEmpty()) {
                add(listOf(transformedRow))
            } else {
                next.transform(transformedRow).forEach {
                    add(listOf(transformedRow) + it)
                }
            }
        }.toList()
    }

    fun List<BeamRow>.calculateTotalSplits(): Int {
        return drop(1).mapIndexed { rowIndex, row ->
            row.beam.mapIndexed { fieldIndex, field ->
                field is Field.Splitter && this[rowIndex].beam[fieldIndex] is Field.Beam
            }.count { it }
        }.sum()
    }

    companion object {
        private val exampleBeam = """
            .......S.......
            ...............
            .......^.......
            ...............
            ......^.^......
            ...............
            .....^.^.^.....
            ...............
            ....^.^...^....
            ...............
            ...^.^...^.^...
            ...............
            ..^...^.....^..
            ...............
            .^.^.^.^.^...^.
            ...............
        """.trimIndent()

        private val beam = """
            ......................................................................S......................................................................
            .............................................................................................................................................
            ......................................................................^......................................................................
            .............................................................................................................................................
            .....................................................................^.^.....................................................................
            .............................................................................................................................................
            ....................................................................^...^....................................................................
            .............................................................................................................................................
            ...................................................................^.^.^.^...................................................................
            .............................................................................................................................................
            ..................................................................^.^.....^..................................................................
            .............................................................................................................................................
            .................................................................^.^.^.^.^.^.................................................................
            .............................................................................................................................................
            ................................................................^.^.......^.^................................................................
            .............................................................................................................................................
            ...............................................................^.^.^...^.^.^.^...............................................................
            .............................................................................................................................................
            ..............................................................^.^.^.^.^.^.^...^..............................................................
            .............................................................................................................................................
            .............................................................^.^.^...^.......^.^.............................................................
            .............................................................................................................................................
            ............................................................^.^.....^.^.^.^.^.^.^............................................................
            .............................................................................................................................................
            ...........................................................^.^...^.^...^.^...^...^...........................................................
            .............................................................................................................................................
            ..........................................................^.^...^...^...^.^...^.^.^..........................................................
            .............................................................................................................................................
            .........................................................^.^.^.^.^.^.....^.^.^...^.^.........................................................
            .............................................................................................................................................
            ........................................................^.^...^...^.^...^.^.^.^...^.^........................................................
            .............................................................................................................................................
            .......................................................^.^.^...^.^...^.^...^.^.^.....^.......................................................
            .............................................................................................................................................
            ......................................................^.^...^...^.^.^.^.^.^...^.^.^...^......................................................
            .............................................................................................................................................
            .....................................................^.^.^.^.^.^...^.^.^...^.........^.^.....................................................
            .............................................................................................................................................
            ....................................................^...^...^.....^.....^.^.^.^.....^.^.^....................................................
            .............................................................................................................................................
            ...................................................^...^.^.^.......^...^.....^.^.^...^.^.^...................................................
            .............................................................................................................................................
            ..................................................^.....^.^.^.^.^.^.^.^.^...^...^.^.^.^...^..................................................
            .............................................................................................................................................
            .................................................^.^.^...^.^.^.....^.^.^.^.....^...^.^.^.^.^.................................................
            .............................................................................................................................................
            ................................................^.^.....^.^...^.^.^...^.....^.^.^.^.^.^...^.^................................................
            .............................................................................................................................................
            ...............................................^.^.^.^.^.^.^...^.^...^.^...^.^...^.^.^.^.^.^.^...............................................
            .............................................................................................................................................
            ..............................................^.^.^.^.^.^...^...^...^...^.^.....^.^.^.^.^...^.^..............................................
            .............................................................................................................................................
            .............................................^...^.^...^.^.^.......^.^...^.^.^.^.^.^...^.^.....^.............................................
            .............................................................................................................................................
            ............................................^...^.^...^.^.^.....^.....^.^.^.^.^.....^.^.....^...^............................................
            .............................................................................................................................................
            ...........................................^.^.^.^.^.^.^.^.^.....^.^.^.^.^...^...^.^.^...^.....^.^...........................................
            .............................................................................................................................................
            ..........................................^.^...^.^.^.^.^.^.^...^...^.^.^...^.^.^.^.^.^...^...^.^.^..........................................
            .............................................................................................................................................
            .........................................^.^...^...^.......^.^.^.^.^.....^.^.^...^.^.^.^.^.^...^.^.^.........................................
            .............................................................................................................................................
            ........................................^.....^.^.....^.^...^.^...^.^.^.^...........^...^.^...^...^.^........................................
            .............................................................................................................................................
            .......................................^.^.^...^.^.^.^.^.^...^.^...^.^.........^.^.^.^.^.^.^.....^.^.^.......................................
            .............................................................................................................................................
            ......................................^.....^.^...........^.^.^.^.......^...^.^.^...^.......^.......^.^......................................
            .............................................................................................................................................
            .....................................^.^.^.....^.^.^.^.^.....^...^.^.^.^.^...^.^...^.^...^...^...^...^.^.....................................
            .............................................................................................................................................
            ....................................^.^.....^...^.^...^.^.....^.^.^.^.^...^.^...^.^...^.^.^.^...^...^...^....................................
            .............................................................................................................................................
            ...................................^...^.^.^.^...^.^...^...^.......^.^.^.^.....^.^.^...^.^...^.^...^.^...^...................................
            .............................................................................................................................................
            ..................................^...^.......^.^.^.^.^.......^.^.^.............^...^.....^...^.^...^.^.^.^..................................
            .............................................................................................................................................
            .................................^.^.^.^.......^.....^.^.^...^.....^.....^.^.^.^...^.^...^.^.^...^.......^.^.................................
            .............................................................................................................................................
            ................................^...^.^.^...^.......^...^.^...^...^.^.^.^.^.^.^.....^.^...^.^...^.^...^.^...^................................
            .............................................................................................................................................
            ...............................^...^.....^.^.^...^...........^.^...^.........^.^.^.^.^...^.^.^.^.^...^.^.^.^.^...............................
            .............................................................................................................................................
            ..............................^.^...^.^.......^.....^.^.^.^...^.^.^...^.^...^.^.^...^.^.^.....^...^.^.^...^...^..............................
            .............................................................................................................................................
            .............................^.^.^...^.^.^...^.^.^.^.^.^.....^...^.^.^...^.....^.^.^.^.^...^...^.^.^.^.^.^.....^.............................
            .............................................................................................................................................
            ............................^.^.^...^.^.^...^.^.....^.^...^.^.^.^...^...^...^.^.^.^.^.^...^.......^.^.^.^.^.^.^.^............................
            .............................................................................................................................................
            ...........................^.^.^.^.^...^...^.^.^.^...^.^.........^.^.^...^.....^.^.^.^...^.^...^.^.....^...^.^.^.^...........................
            .............................................................................................................................................
            ..........................^...^...^.^.^.^.^.^.^.^.^.^.^...^...^...^.^.^.^.^...^.......^.^...^.^.^.^.^.....^.^...^.^..........................
            .............................................................................................................................................
            .........................^.^...^.^.^.^.^.^...^...^...^.....^...^.^.^.^...^.....^.^...^.^...^...^...^.^.^.^.^...^...^.........................
            .............................................................................................................................................
            ........................^.^...^...^.^...^.^.^.^.^...^.......^...^.^.....^.^.^.....^...^.^.^.^.^.^.^...^.^...^...^.^.^........................
            .............................................................................................................................................
            .......................^.^.^.^.^.^.^...^.......^...^.^.^.^.^.^...^.^.^...........^.^.^.^...^.^.....^.^.^.^...^.^.^...^.......................
            .............................................................................................................................................
            ......................^.^.....^.^...^.^.....^.^.^...^.^.^.^.^.^...^.^.....^.....^...^.^.^.^.^.^.......^.^.^.^...^.^.^.^......................
            .............................................................................................................................................
            .....................^.^.^...^.^.^.....^.^.^.^...^...^.^.^.^.^.^.^.^.^.^.^...^.^.........^.^.^.^.^.^.^...^.....^...^...^.....................
            .............................................................................................................................................
            ....................^.......^...^.^.^.^.............^.^.^.^.^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.......^...^.^.^.^.^.^.^.^....................
            .............................................................................................................................................
            ...................^.^.^.^.^.............^.^.^.^.^.^.^.^...^.^.^.^...^.^.^.........^.^...^...^.^.^...^.^.^.^...^.^.^...^.^...................
            .............................................................................................................................................
            ..................^...^.^.^...^.^.^...^.^.^.....^.^.^.^.^.^.^.^...^...........^.^.^...^.....^...^.^.^.......^.^.....^.^.^.^..................
            .............................................................................................................................................
            .................^...^.^...^.....^.^.^...^.^.^.^...^.^.^...^...^.^.^.^.^.^.^.....^.^.^.....^...^...^.^.^...^.^...^.^...^...^.................
            .............................................................................................................................................
            ................^.^.^.^.^.^.^.^...^.......^.^.^.....^.^.^...^.....^.^...^.^.^.......^.^.^.^...^.....^.^...^.^.^.^.......^...^................
            .............................................................................................................................................
            ...............^.^.^.^...^...^.^.^.....^.^.^.^...^.^.^.^.^.^...^.^.^.^...^.^...^.^.^.......^.^.^.^...^.^.^.^.^.^...^.^.^...^.^...............
            .............................................................................................................................................
            ..............^.^...^...^...^...^.^.^.^.^.......^.^.^.^.^...^.....^.^.^.^.......^.^.^.^.^.^.^.^.^...^...^.^.^.^.^.^...^.^...^.^..............
            .............................................................................................................................................
            .............^.^...^.^.^...^...^.......^.....^.^...^.......^.^.^.^...^.^.^.^...^.^.^.......^.^.......^.^...^.^.^.^.^.^.^.^.^.^.^.............
            .............................................................................................................................................
            ............^.^...^.^.....^.^.^...^.^...^.^.^.......^.^.^.^.^.^.....^...^.....^.^.^...^.^...^...^.^.^.^.......^.......^.^.^.^.^.^............
            .............................................................................................................................................
            ...........^.......^...^...^.....^.^...^.^...^...........^.^.^.^...^.......^...^.^.^.....^.^.....^.....^.^...^.^.^.^.^.^.^.....^.^...........
            .............................................................................................................................................
            ..........^.....^.^.....^.^.^.^.^...^.^...^.^.^.^.^.^.^.^...^.^...^...^.^.^.^.^...^.^.....^.^...^...^...^.....^.^.^.^.^.^.^.^.^.^.^..........
            .............................................................................................................................................
            .........^.^.^.^.^...^.^...^.^.^...^.^.^...^.^.^.^.^.^.^.^...^.^.^.^.^...^.^.^...^.^...^.^.^.^.^...^...^.^.^.^.....^...^.....^.^.^.^.........
            .............................................................................................................................................
            ........^.^.^...^.^.^.^.^.^.^.^.^.^.....^.....^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.....^.^.....^.^.....^.....^...^...^.....^...^.......^........
            .............................................................................................................................................
            .......^.^.^.^.^.^.....^.^.^.^.^.^.^...^.^...^.....^.^...^.^.^.^.^...^...^.^.^.^.^.^.....^.^...^.....^.^.^.^.^.^.^.^.^...^.^.^...^...^.......
            .............................................................................................................................................
            ......^.^...^.^...^.^.^.^...^...^...^.^...^.......^.^...^.^.^.....^.^.^.^.^.^...^.^...^...^.^...^.^.^.^.^.^.^.^.......^.^.^...^...^...^......
            .............................................................................................................................................
            .....^.^.^.^.^.^.^.....^.....^.^...^...^.^.^...^...^.^...^.^.^.^...^.^.^.^.^.^.^.....^.^.^...^.^.^.^.......^...^.^.......^.^.^.........^.....
            .............................................................................................................................................
            ....^...^.^.^.^...^.....^...^...^.^.^.^.^.^.^.......^.^.^.^.^.^...^.^.....^.^...^.^.......^.^...^...^.^.^.^...^.^.^.^.......^.^.^.^...^.^....
            .............................................................................................................................................
            ...^.^...^...^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^.^.^.^.^...^...^.^...^.....^.^.....^.^.^...^.^.^.^.^...........^...^...^.^.^.....^.^...
            .............................................................................................................................................
            ..^...........^.^.^.^.^.^.....^...^.^.^.^.^...^.^...^.^.^.^.^.^...^.^...^.^.^...^...^...^.^.^.^.^.^.^...^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^..
            .............................................................................................................................................
            .^...^...^.^.........^...^.^.^.....^...^...^.^.^.^.^...^.^.^.^.^...^.........^.^...^.^.^...^.^.^.^.^...^.^.^.^.^.^.^.....^.....^.....^.^.^.^.
            .............................................................................................................................................
        """.trimIndent()
    }
}

data class BeamRow(
    val beam: List<Field>
) {
    fun transform(previousRow: BeamRow): BeamRow {
        val transformedBeam = beam.toMutableList()

        beam.forEachIndexed { index, field ->
            val previousField = previousRow.beam[index]
            val newValue = when (field) {
                Field.Start -> Field.Start
                Field.Empty -> {
                    when (previousField) {
                        Field.Start -> Field.Beam(previousField.value)
                        Field.Empty -> Field.Empty
                        is Field.Splitter -> Field.Empty
                        is Field.Beam -> Field.Beam(previousField.value)
                    }
                }
                is Field.Beam -> Field.Beam(previousField.value)
                is Field.Splitter -> {
                    when (previousRow.beam[index]) {
                        is Field.Beam -> Field.Splitter(previousField.value)
                        is Field.Start -> Field.Splitter(previousField.value)
                        else -> Field.Empty
                    }
                }
            }

            transformedBeam[index] = newValue
        }

        transformedBeam.forEachIndexed { index, field ->
            if (field is Field.Splitter) {
                transformedBeam[index - 1] = with (transformedBeam[index - 1]) {
                    when (this) {
                        Field.Empty -> {
                            Field.Beam(field.value)
                        }

                        is Field.Beam -> {
                            Field.Beam(field.value + this.value)
                        }

                        else -> throw IllegalStateException("Unsupported field")
                    }
                }

                transformedBeam[index + 1] = with(transformedBeam[index + 1]) {
                    when (this) {
                        Field.Empty -> {
                            Field.Beam(field.value)
                        }

                        is Field.Beam -> {
                            Field.Beam(field.value + this.value)
                        }

                        else -> throw IllegalStateException("Unsupported field")
                    }
                }
            }
        }

        return BeamRow(transformedBeam)
    }

    companion object {
        fun fromString(string: String): BeamRow {
            val fields = string.map {
                when (it) {
                    '.' -> Field.Empty
                    '|' -> Field.Beam(1)
                    'S' -> Field.Start
                    '^' -> Field.Splitter(1)
                    else -> throw IllegalStateException("Unsupported character")
                }
            }

            return BeamRow(fields.toMutableList())
        }
    }
}

fun List<BeamRow>.print() {
    forEach {
        println(
            it.beam.joinToString {
                it.print()
            }
        )
    }
}

sealed class Field(open val value: Long) {
    data object Start: Field(1)
    data object Empty: Field(0)
    data class Splitter(override val value: Long): Field(value)
    data class Beam(override val value: Long): Field(value)

    fun print(): String {
        val prefix = when (this) {
            is Start -> "S"
            is Empty -> "."
            is Splitter -> "^"
            is Beam -> "|"
        }

        return "$prefix($value)"
    }
}
